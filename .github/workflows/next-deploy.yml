name: Build & Deploy Next.js (pnpm) to Azure App Service

on:
  push:
    branches: [main]
  workflow_dispatch:

env: # keep your existing secrets / public‑env
  WEBAPP_NAME: "Quail-Next"
  AZURE_PUBLISH_PROFILE: ${{ secrets.APP_PUBLISH_PROFILE }}
  STRIPE_SK: ${{ secrets.STRIPE_SK }}
  STRIPE_ENDPOINT_SECRET: ${{ secrets.STRIPE_ENDPOINT_SECRET }}
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  SUPABASE_ADMIN: ${{ secrets.SUPABASE_ADMIN }}
  NEXT_PUBLIC_AZURE_RESOURCE_NAME: ${{ secrets.NEXT_PUBLIC_AZURE_RESOURCE_NAME }}
  NEXT_PUBLIC_AZURE_API_KEY: ${{ secrets.NEXT_PUBLIC_AZURE_API_KEY }}
  NEXT_PUBLIC_AZURE_FUNCTION_ENDPOINT: ${{ secrets.NEXT_PUBLIC_AZURE_FUNCTION_ENDPOINT }}
  NEXT_PUBLIC_STRIPE_PK: ${{ secrets.NEXT_PUBLIC_STRIPE_PK }}
  NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
  NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 1️⃣  Install pnpm + Node (with built‑in cache)
      - uses: pnpm/action-setup@v4
        with:
          version: 10.10.0 # pin to the version you use locally
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm # node‑modules cache keyed on pnpm‑lock.yaml

      # 2️⃣  Production install & build
      - name: Install deps & build
        run: |
          pnpm install --frozen-lockfile
          pnpm run build
          pnpm prune --prod      # remove devDependencies

      # 3️⃣  Zip only the runtime artefacts
      - name: Package site
        run: |
          zip -r build.zip \
            .next public package.json pnpm-lock.yaml node_modules \
            next.config.* 2>/dev/null || true

      # 4️⃣  Deploy to App Service
      - uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.WEBAPP_NAME }}
          slot-name: Production
          publish-profile: ${{ env.AZURE_PUBLISH_PROFILE }}
          package: build.zip
